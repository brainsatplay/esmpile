<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote ESM</title>
    <style>
        html, body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        i {
            font-size: 80%;
        }

        h1 {
            margin: 0;
        }

        section {
            padding: 50px;
        }

        li {
            padding: 10px;
        }

    </style>
</head>
<body>
    <section>
        <h1>Remote ESM</h1>
        <i>View the Developer Console for outputs</i>
        <ul></ul>
    </section>
</body>
<script type="module">

    import * as library from './index.js';

    let remoteESM = library

    // ---------------- Set Options ----------------
    const options = {
        onImport: (path, info) => {
            if (path.includes('worker')) {
                console.log('Creating a dummy worker!', new Worker(info.objecturl, {type:"module"}))
            }
        },
        callbacks: {
            progress: {
                fetch: (path, i, total, done, range) => {
                    if (done) console.log('Fetch Complete!', path)
                    else console.log('Fetch Progress', path, i, total, range)
                }
            }
        }
    }

    options.bundle = 'global' // Specify which bundle to reference. Specify 'global' to use same bundle across all imports. Don't specify to create a new bundle
    options.bundler = 'objecturl' // Specify what sort of link to import with | Can be 'datauri' (saveable) or 'objecturl' (runtime only)
    options.dependencies = {} // Track all file dependencies
    options.debug = false // Show debug messages

    // ---------------- Declare Utilities ----------------
    const basePath = (str) => str.substring(0, str.lastIndexOf("/"));
    const ul = document.body.querySelector('ul')
    const importRemoteESM = async (path, options, opts) => {
        const res = await remoteESM.safe(path, options).catch(e => console.error('Failed', e));
        console.log(`---------------- ${opts.label} ----------------`)
        console.log(path, res)
        ul.insertAdjacentHTML('beforeend', `<li>${res ? 'Got' : 'Failed to get'} ${path}</li>`);
        return res
    }

    // ---------------- Replace Library with Self Import ----------------
    remoteESM = await importRemoteESM('./index.js', options, {label: 'self'});

    // ---------------- Preload the Typescript Service ----------------
    await remoteESM.load.script('./extensions/typescriptServices.js');

    //---------------- Test Source Map Resolution for Self Distribution ----------------
    const sourceURI = './dist/index.esm.js'
    await importRemoteESM(sourceURI, {
        output: {
            text: true
        },
        onImport: async (path, info) => {
            if (path === sourceURI){
                let sourcemap = await remoteESM.sourceMap.get(sourceURI, options, info.text.updated)
                if (sourcemap){
                    console.log('source map!', sourcemap)
                } else console.log('No source map at specified location:', sourceURI)
            }
    }}, {label: 'source map'});


    //---------------- Start Demo ----------------

    const uriOne = 'https://raw.githubusercontent.com/garrettmflynn/phaser/main/scripts/player/update.js'
    const complexURI = basePath(window.location.href) + '/tests/index.js'
    const nodeModuleURI = 'device-decoder'
    const typescriptURI = 'device-decoder/stream.big.worker.ts'

    await importRemoteESM(uriOne, options, {label: 'remote'});
    
    const complex = await importRemoteESM(complexURI, options, {label: 'complex uri (remote + direct)'});
    console.log('Executed', complex.imports.default())
    
    const complexOptions = Object.assign(Object.assign({}, options), {forceImportFromText: true})
    const complexFromText = await importRemoteESM(complexURI, complexOptions, {label: 'complex uri (remote + text)'});
    console.log('Executed',  complexFromText.imports.default())

    try {
        await importRemoteESM(nodeModuleURI, options, {label: 'node module (device-decoder distribution)'});
        await importRemoteESM(typescriptURI, options, {label: 'node module (complex typescript worker)'});
    } catch (e) {
        console.log('node_modules are not served:', nodeModuleURI, typescriptURI)
    }

</script>
</html>