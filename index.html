<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote ESM</title>
    <style>
        html, body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        i {
            font-size: 80%;
        }

        h1 {
            margin: 0;
        }

        section {
            padding: 50px;
        }

        li {
            padding: 10px;
        }

    </style>
</head>
<body>
    <section>
        <h1>Remote ESM</h1>
        <i>View the Developer Console for outputs</i>
        <ul></ul>
    </section>
</body>
<script type="module">

    import * as remoteESM from './index.js';

    // Preload the Typescript Service
    await remoteESM.load.script('./extensions/typescriptServices.js');

    const options = {
        onImport: (path, info) => {
            console.log('Got New Info', path, info)
            if (path.includes('worker')) {
                console.log('Creating a worker!', new Worker(info.objecturl, {type:"module"}))
            }
        }
    }

    const basePath = (str) => str.substring(0, str.lastIndexOf("/"));

    const ul = document.body.querySelector('ul')
    const importRemoteESM = async (path, options, opts) => {

        const res = await remoteESM.safe(path, options).catch(e => {
            console.error('Failed', e)
        });

        console.log(`---------------- ${opts.label} ----------------`)
        console.log(path, res)
        ul.insertAdjacentHTML('beforeend', `<li>${res ? 'Got' : 'Failed to get'} ${path}</li>`);
        return res
    }


    const uriOne = 'https://raw.githubusercontent.com/garrettmflynn/phaser/main/scripts/player/update.js'
    const selfURI = './index.js'
    const complexURI = basePath(window.location.href) + '/tests/index.js'
    const sourceURI = new URL('index.js', window.location.href).href
    const nodeModuleURI = 'device-decoder'
    const typescriptURI = 'device-decoder/stream.big.worker.ts'

    await importRemoteESM(uriOne, options, {label: 'remote'});
    
    // await importRemoteESM(sourceURI, {
    //     output: {
    //         text: true
    //     },
    //     onImport: async (path, info) => {
    //     let sourcemap = await remoteESM.sourceMap.get(sourceURI, info.text)
    //     if (sourcemap){
    //         console.log('source map!', sourcemap)
    //     }
    // }}, {label: 'source map'});

    // await importRemoteESM(selfURI, options, {label: 'self'});

    // const complex = await importRemoteESM(complexURI, options, {label: 'complex uri (remote + direct)'});
    // console.log('Executed', complex.imports.default())
    
    // const complexOptions = Object.assign(Object.assign({}, options), {forceImportFromText: true})
    // const complexFromText = await importRemoteESM(complexURI, complexOptions, {label: 'complex uri (remote + text)'});
    // console.log('Executed',  complexFromText.imports.default())

    try {
        await importRemoteESM(nodeModuleURI, options, {label: 'node module (device-decoder distribution)'});
        await importRemoteESM(typescriptURI, options, {label: 'node module (complex typescript worker)'});
    } catch (e) {
        console.log('node_modules not served:', nodeModuleURI, typescriptURI)
    }

</script>
</html>